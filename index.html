<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Oran9eCat</title>
  <style>
    :root{--fg:#111;--muted:#666;--bg:#fff;--card:#f6f7f9;--line:#e6e8eb;}
    body{
      max-width:900px;margin:48px auto;padding:0 18px;
      line-height:1.75;color:var(--fg);background:var(--bg);
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    }
    h1{margin:0;font-size:2rem}
    h2{margin:28px 0 12px 0;font-size:1.25rem}
    .muted{color:var(--muted)}
    a{color:inherit;text-decoration:none;border-bottom:1px solid transparent}
    a:hover{border-bottom-color:var(--fg)}
    .card{
      background:var(--card);border:1px solid var(--line);
      border-radius:14px;padding:14px 16px;margin:12px 0;
    }
    ul{margin:10px 0 0 0;padding-left:18px}
    li{margin:8px 0}
    .pill{
      display:inline-block;font-size:.85rem;padding:2px 10px;border-radius:999px;
      border:1px solid var(--line);background:#fff;margin-left:8px;color:var(--muted)
    }

    /* Topbar + Updates dropdown */
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      margin-bottom:6px;
    }
    .updates{ position:relative; margin-top:4px; }
    .updates-btn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:8px 12px;
      cursor:pointer;
      color:var(--muted);
    }
    .updates-btn:hover{ color:var(--fg); }
    .updates-panel{
      position:absolute;
      right:0;
      top:42px;
      width:min(420px, 80vw);
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      box-shadow:0 12px 30px rgba(0,0,0,.08);
      padding:12px 12px 10px;
      z-index:20;
    }
    .updates-title{ font-weight:600; margin:2px 0 10px; }
    .updates-panel ul{ margin:0; padding-left:18px; }
    .updates-panel li{ margin:8px 0; }
    .updates-foot{ margin-top:10px; font-size:.9rem; }
    .quote{ margin:10px 0 0 0; }
  </style>
</head>

<body>
  <div class="topbar">
    <h1>Oran9eCat</h1>

    <div class="updates">
      <button id="updatesBtn" class="updates-btn" type="button">最近更新</button>
      <div id="updatesPanel" class="updates-panel" hidden>
        <div class="updates-title">最近更新</div>
        <div id="updatesList" class="muted">加载中…</div>
        <div class="updates-foot muted">
          数据来自本仓库对 <code>PDF/</code> 的提交记录
        </div>
      </div>
    </div>
  </div>

  <p class="muted quote">雄关漫道真如铁，而今迈步从头越。从头越，苍山如海，残阳如血。</p>

  <h2>文档</h2>

  <div class="card">
    <div><a href="/PDF/史济怀_数学分析教程_下册.pdf">史济怀《数学分析教程》下册</a><span class="pill">PDF</span></div>
    <div class="muted">Mathematics / 大学数学基础 - 分析学</div>
  </div>

  <div class="card">
    <div><a href="/PDF/丘维声_高等代数_上册.pdf">丘维声《高等代数》上册</a><span class="pill">PDF</span></div>
    <div class="muted">Mathematics / 大学数学基础 - 代数学</div>
  </div>

  <div class="card">
    <div><a href="/PDF/何书元_应用时间序列分析_.pdf">何书元《应用时间序列分析》</a><span class="pill">PDF</span></div>
    <div class="muted">Mathematics / 概率统计方向 - 时序分析</div>
  </div>

  <h2>联系</h2>
  <ul>
    <li>Email: or_cat@mail.ustc.edu.cn</li>
  </ul>

  <script>
    // === 配置：你的仓库信息 ===
    const OWNER = "Oran9eCat";
    const REPO  = "Oran9eCat.github.io";
    const FOLDER_PATH = "PDF";     // 注意：你的文件夹是大写 PDF
    const SHOW_N = 6;              // 显示最近几条

    const btn = document.getElementById("updatesBtn");
    const panel = document.getElementById("updatesPanel");
    const listEl = document.getElementById("updatesList");

    function fmtDate(iso){
      const d = new Date(iso);
      return new Intl.DateTimeFormat("zh-CN", {year:"numeric", month:"2-digit", day:"2-digit"}).format(d);
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function fileLink(path){
      // 把 "PDF/xxx.pdf" 变成站点路径 "/PDF/xxx.pdf"，并对中文做 URL 编码
      const parts = path.split("/");
      const fileName = parts.slice(1).join("/");
      return `/${FOLDER_PATH}/${encodeURIComponent(fileName)}`;
    }

    async function loadUpdates(){
      const commitsUrl = `https://api.github.com/repos/${OWNER}/${REPO}/commits?path=${encodeURIComponent(FOLDER_PATH)}&per_page=${SHOW_N}`;
      const commitsResp = await fetch(commitsUrl, {headers: {"Accept":"application/vnd.github+json"}});
      if(!commitsResp.ok) throw new Error("无法读取 commits");
      const commits = await commitsResp.json();

      const detailList = await Promise.all(commits.map(async (c) => {
        const sha = c.sha;
        const detailUrl = `https://api.github.com/repos/${OWNER}/${REPO}/commits/${sha}`;
        const detailResp = await fetch(detailUrl, {headers: {"Accept":"application/vnd.github+json"}});
        if(!detailResp.ok) return null;
        const detail = await detailResp.json();

        const when = detail.commit?.author?.date || c.commit?.author?.date;
        const files = (detail.files || [])
          .map(f => ({name: f.filename, status: f.status}))
          .filter(f => f.name.startsWith(FOLDER_PATH + "/"));

        return {
          when,
          html_url: detail.html_url,
          message: (detail.commit?.message || "").split("\n")[0],
          files
        };
      }));

      const items = detailList.filter(Boolean);

      if(items.length === 0){
        listEl.innerHTML = '<span class="muted">暂无更新记录</span>';
        return;
      }

      const html = [
        "<ul>",
        ...items.map(it => {
          const date = fmtDate(it.when);
          const msg = escapeHtml(it.message || "Update");
          const filesHtml = (it.files && it.files.length)
            ? (" · " + it.files.slice(0,3).map(f => {
                const nice = escapeHtml(f.name.split("/").slice(1).join("/"));
                const status = f.status; // added/modified/removed
                if(status === "removed"){
                  return `<span class="muted">删除 ${nice}</span>`;
                }
                return `<a href="${fileLink(f.name)}">${nice}</a>`;
              }).join("、") + (it.files.length > 3 ? "…" : ""))
            : "";

          return `<li><span class="muted">${date}</span> · <a href="${it.html_url}" target="_blank" rel="noopener">#</a> ${msg}${filesHtml}</li>`;
        }),
        "</ul>"
      ].join("");

      listEl.innerHTML = html;
    }

    let loaded = false;

    btn.addEventListener("click", async () => {
      const willShow = panel.hidden;
      panel.hidden = !willShow;

      if(willShow && !loaded){
        try{
          await loadUpdates();
          loaded = true;
        }catch(e){
          listEl.innerHTML = '<span class="muted">加载失败（可能是 GitHub API 限流），稍后再试。</span>';
        }
      }
    });

    // 点击面板外关闭
    document.addEventListener("click", (e) => {
      if(panel.hidden) return;
      if(panel.contains(e.target) || btn.contains(e.target)) return;
      panel.hidden = true;
    });
  </script>
</body>
</html>

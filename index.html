<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Oran9eCat</title>

  <style>
    :root{--fg:#111;--muted:#666;--bg:#fff;--card:#f6f7f9;--line:#e6e8eb;}

    body{
      max-width:900px;margin:48px auto;padding:0 18px;
      line-height:1.75;color:var(--fg);background:var(--bg);
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    }

    h1{margin:0;font-size:2rem}
    h2{margin:28px 0 12px 0;font-size:1.25rem}
    .muted{color:var(--muted)}

    a{color:inherit;text-decoration:none;border-bottom:1px solid transparent}
    a:hover{border-bottom-color:var(--fg)}

    .card{
      background:var(--card);border:1px solid var(--line);
      border-radius:14px;padding:14px 16px;margin:12px 0;
    }

    ul{margin:10px 0 0 0;padding-left:18px}
    li{margin:8px 0}

    .pill{
      display:inline-block;font-size:.85rem;padding:2px 10px;border-radius:999px;
      border:1px solid var(--line);background:#fff;margin-left:8px;color:var(--muted)
    }

    /* Topbar + Updates dropdown */
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      margin-bottom:6px;
    }

    .updates{ position:relative; margin-top:4px; }

    .updates-btn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:8px 12px;
      cursor:pointer;
      color:var(--muted);
    }

    .updates-btn:hover{ color:var(--fg); }

    .updates-panel{
      position:absolute;
      right:0;
      top:42px;
      width:min(520px, 86vw);
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      box-shadow:0 12px 30px rgba(0,0,0,.08);
      padding:12px 12px 10px;
      z-index:20;
    }

    .updates-title{ font-weight:600; margin:2px 0 10px; }
    .updates-foot{ margin-top:10px; font-size:.9rem; }

    .quote{ margin:10px 0 0 0; }

    /* Updates: two-column layout */
    .updates-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px 14px;
    }
    .updates-item{
      margin:0;
      line-height:1.45;
    }
    .updates-item .date{
      display:inline-block;
      margin-right:6px;
      white-space:nowrap;
    }
    .updates-item a{
      display:inline-block;
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      vertical-align:bottom;
      white-space:nowrap;
    }
    @media (max-width: 520px){
      .updates-grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <h1>Oran9eCat</h1>

    <div class="updates">
      <button id="updatesBtn" class="updates-btn" type="button">最近更新</button>
      <div id="updatesPanel" class="updates-panel" hidden>
        <div class="updates-title">最近更新</div>
        <div id="updatesList" class="muted">加载中…</div>
        <div class="updates-foot muted">
          仅显示最近 7 天内更新过的文档（每个文件只保留最近一次更新时间）
        </div>
      </div>
    </div>
  </div>

  <p class="muted quote">雄关漫道真如铁，而今迈步从头越。从头越，苍山如海，残阳如血。</p>

  <h2>文档</h2>

  <div class="card">
    <div><a href="/PDF/史济怀_数学分析教程_下册.pdf">史济怀《数学分析教程》下册</a><span class="pill">PDF</span></div>
    <div class="muted">Mathematics / 大学数学基础 - 分析学</div>
  </div>

  <div class="card">
    <div><a href="/PDF/丘维声_高等代数_上册.pdf">丘维声《高等代数》上册</a><span class="pill">PDF</span></div>
    <div class="muted">Mathematics / 大学数学基础 - 代数学</div>
  </div>

  <div class="card">
    <div><a href="/PDF/何书元_应用时间序列分析_.pdf">何书元《应用时间序列分析》</a><span class="pill">PDF</span></div>
    <div class="muted">Mathematics / 概率统计方向 - 时序分析</div>
  </div>

  <h2>联系</h2>
  <ul>
    <li>Email: or_cat@mail.ustc.edu.cn</li>
  </ul>

  <script>
    // === 配置：你的仓库信息 ===
    const OWNER = "Oran9eCat";
    const REPO  = "Oran9eCat.github.io";
    const FOLDER_PATH = "PDF";              // 你的文件夹是大写 PDF
    const WINDOW_HOURS = 168;               // 7 天 = 168 小时
    const COMMITS_PER_PAGE = 30;            // 每页 commit 数
    const MAX_COMMIT_PAGES = 5;             // 最多翻页次数（防止无限请求）
    const MAX_FILES_SHOW = 30;              // 面板最多显示多少个文件（防太长）

    const btn = document.getElementById("updatesBtn");
    const panel = document.getElementById("updatesPanel");
    const listEl = document.getElementById("updatesList");

    function fmtDateCN(iso){
      const d = new Date(iso);
      const y = d.getFullYear();
      const m = d.getMonth() + 1;
      const day = d.getDate();
      return `${y}.${m}.${day}`;
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function fileLink(path){
      // "PDF/xxx.pdf" -> "/PDF/xxx.pdf"（中文做 URL 编码）
      const fileName = path.split("/").slice(1).join("/");
      return `/${FOLDER_PATH}/${encodeURIComponent(fileName)}`;
    }

    function shortName(path){
      // "PDF/史济怀_数学分析教程_下册.pdf" -> "史济怀_数学分析教程_下册.pdf"
      return path.split("/").slice(1).join("/");
    }

    async function fetchCommitsPage(page){
      const url =
        `https://api.github.com/repos/${OWNER}/${REPO}/commits` +
        `?path=${encodeURIComponent(FOLDER_PATH)}` +
        `&per_page=${COMMITS_PER_PAGE}` +
        `&page=${page}`;
      const resp = await fetch(url, { headers: { "Accept": "application/vnd.github+json" } });
      if(!resp.ok) throw new Error("无法读取 commits");
      return await resp.json();
    }

    async function fetchCommitDetail(sha){
      const url = `https://api.github.com/repos/${OWNER}/${REPO}/commits/${sha}`;
      const resp = await fetch(url, { headers: { "Accept": "application/vnd.github+json" } });
      if(!resp.ok) return null;
      return await resp.json();
    }

    async function loadUpdates(){
      const now = Date.now();
      const cutoff = now - WINDOW_HOURS * 60 * 60 * 1000;

      // file -> latestDateISO
      const latestByFile = new Map();

      // 1) 分页抓 commits（只要超出时间窗口就可以停）
      let commits = [];
      for(let page=1; page<=MAX_COMMIT_PAGES; page++){
        const pageCommits = await fetchCommitsPage(page);
        if(!Array.isArray(pageCommits) || pageCommits.length === 0) break;

        commits.push(...pageCommits);

        // 如果这一页里最老的 commit 都早于 cutoff，就停止
        const oldest = pageCommits[pageCommits.length - 1];
        const oldestTime = new Date(oldest.commit?.author?.date || oldest.commit?.committer?.date || 0).getTime();
        if(oldestTime < cutoff) break;
      }

      // 2) 逐条看 commit 详情，聚合到文件（只保留 added/modified；删除不列入“最近更新文档”）
      for(const c of commits){
        const whenIso = c.commit?.author?.date || c.commit?.committer?.date;
        const whenMs = new Date(whenIso || 0).getTime();
        if(!whenIso || whenMs < cutoff) continue;

        const detail = await fetchCommitDetail(c.sha);
        if(!detail) continue;

        const files = (detail.files || [])
          .map(f => ({ filename: f.filename, status: f.status }))
          .filter(f => f.filename && f.filename.startsWith(FOLDER_PATH + "/"))
          .filter(f => f.status === "added" || f.status === "modified");

        for(const f of files){
          const prev = latestByFile.get(f.filename);
          if(!prev || new Date(prev).getTime() < whenMs){
            latestByFile.set(f.filename, whenIso);
          }
        }
      }

      // 3) 渲染（两列）
      if(latestByFile.size === 0){
        listEl.innerHTML = '<span class="muted">最近一周没有更新~</span>';
        return;
      }

      const rows = Array.from(latestByFile.entries())
        .map(([filename, whenIso]) => ({
          filename,
          whenIso,
          whenMs: new Date(whenIso).getTime()
        }))
        .sort((a,b) => b.whenMs - a.whenMs)
        .slice(0, MAX_FILES_SHOW);

      const html = [
        '<div class="updates-grid">',
        ...rows.map(r => {
          const date = fmtDateCN(r.whenIso);
          const name = escapeHtml(shortName(r.filename));
          const href = fileLink(r.filename);
          return `<div class="updates-item"><span class="muted date">${date}</span><a href="${href}">${name}</a></div>`;
        }),
        "</div>"
      ].join("");

      listEl.innerHTML = html;
    }

    let loaded = false;

    btn.addEventListener("click", async () => {
      const willShow = panel.hidden;
      panel.hidden = !willShow;

      if(willShow && !loaded){
        try{
          await loadUpdates();
          loaded = true;
        }catch(e){
          listEl.innerHTML = '<span class="muted">加载失败（可能是 GitHub API 限流），稍后再试。</span>';
        }
      }
    });

    // 点击面板外关闭
    document.addEventListener("click", (e) => {
      if(panel.hidden) return;
      if(panel.contains(e.target) || btn.contains(e.target)) return;
      panel.hidden = true;
    });
  </script>
</body>
</html>
